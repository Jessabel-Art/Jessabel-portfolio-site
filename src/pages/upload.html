<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Client Upload</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    html,body{margin:0;padding:0;background:#FEE6D4;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;color:#3b2a22}
    .wrap{max-width:720px;margin:40px auto;padding:20px}
    .card{background:#fff;border:1px solid rgba(0,0,0,.06);border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.08);padding:20px}
    h1{margin:0 0 8px}
    .muted{color:rgba(0,0,0,.65)}
    label{display:block;margin:.25rem 0 .5rem;font-weight:600}
    input[type="tel"]{width:220px;height:52px;border-radius:12px;border:1px solid rgba(0,0,0,.15);text-align:center;font-size:24px;letter-spacing:.35em;background:#fff}
    .row{display:flex;gap:10px;flex-wrap:wrap;margin-top:14px}
    .btn{appearance:none;cursor:pointer;border:0;border-radius:999px;padding:12px 18px;font-weight:700;color:#fff;background:linear-gradient(135deg,#ff3ea5,#6a5cff);box-shadow:0 8px 20px rgba(0,0,0,.15)}
    .btn-ghost{background:#fff;color:#333;border:1px solid rgba(0,0,0,.12);box-shadow:none}
    .error{margin-top:10px;color:#d74708;font-weight:700}
    .ok{margin-top:10px;color:#1d7d4f;font-weight:700}
    a.link{font-weight:700}
    #fallback{display:none;margin-top:14px}
  </style>
  <!-- Cloudinary widget script (loaded here so it's available when we open it) -->
  <script src="https://widget.cloudinary.com/v2.0/global/all.js" type="text/javascript"></script>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Secure Client Upload</h1>
      <p class="muted">Enter your 4-digit PIN to open your upload window. No login required.</p>

      <label for="pin">4-digit PIN</label>
      <input id="pin" type="tel" inputmode="numeric" maxlength="4" placeholder="1234" aria-label="PIN" />
      <div class="row">
        <button id="unlock" class="btn">Unlock</button>
        <button id="clear" class="btn btn-ghost" type="button">Clear</button>
      </div>

      <div id="msg" class="error" style="display:none;"></div>
      <div id="ok" class="ok" style="display:none;"></div>

      <!-- Fallback direct link if the embedded widget can’t open -->
      <div id="fallback" class="muted">
        Having trouble? Use the basic uploader:
        <div><a id="fallbackLink" class="link" href="#" target="_blank" rel="noreferrer">Open uploader</a></div>
      </div>
    </div>
  </div>

  <script>
    /* === Your Cloudinary config === */
    const CLOUD_NAME = 'dqqee8c51';
    const UPLOAD_PRESET = 'sanchezservices'; // must be UNSIGNED

    /* === PIN → client folder map === */
    const CLIENTS = [
      { name: 'ACME Corp',        pin: '7431', folder: 'acme' },
      { name: 'Neoterra Inc.',    pin: '8190', folder: 'neoterra' },
      { name: 'Sanchez Services', pin: '1122', folder: 'sanchez' },
    ];
    const ROOT_FOLDER = 'client_uploads';

    /* === DOM handles === */
    const $pin = document.getElementById('pin');
    const $unlock = document.getElementById('unlock');
    const $clear = document.getElementById('clear');
    const $msg = document.getElementById('msg');
    const $ok = document.getElementById('ok');
    const $fallback = document.getElementById('fallback');
    const $fallbackLink = document.getElementById('fallbackLink');

    let widget;           // Cloudinary widget instance
    let currentFolder;    // client-specific folder
    let currentClient;    // client object

    function showError(t){ $msg.style.display='block'; $msg.textContent=t; $ok.style.display='none'; }
    function showOk(t){ $ok.style.display='block'; $ok.textContent=t; $msg.style.display='none'; }
    function hideMsgs(){ $msg.style.display='none'; $ok.style.display='none'; }

    function findClient(pin){ return CLIENTS.find(c => c.pin === pin); }

    // Build the hosted uploader fallback link (keep it minimal: only required params)
    function buildFallbackLink(){
      const base = 'https://widget.cloudinary.com/v2/uploader';
      const qs = new URLSearchParams({ cloud_name: CLOUD_NAME, upload_preset: UPLOAD_PRESET });
      return `${base}?${qs.toString()}`;
    }

    function createWidgetIfNeeded(){
      // Guard against script not present / blocked
      if (!window.cloudinary || typeof window.cloudinary.createUploadWidget !== 'function') {
        // Show minimal fallback link
        $fallbackLink.href = buildFallbackLink();
        $fallback.style.display = 'block';
        showError('Could not load the embedded uploader. Use the basic uploader link below.');
        return false;
      }
      if (widget) return true;

      widget = window.cloudinary.createUploadWidget(
        {
          cloudName: CLOUD_NAME,
          uploadPreset: UPLOAD_PRESET,
          folder: currentFolder,          // per-client folder
          sources: ['local','url','camera'], // keep simple to avoid provider issues
          multiple: true,
          resourceType: 'auto',
          showAdvancedOptions: false
          // Do NOT over-constrain (formats/size) here; enforce in the preset for reliability
        },
        (err, result) => {
          if (err) {
            console.error('Upload error:', err);
            showError('Upload error. Please try again or use the basic uploader link.');
            return;
          }
          if (result && result.event === 'success') {
            // Optional: notify success (don’t clutter UI)
            console.log('Uploaded:', result.info.secure_url);
          }
        }
      );
      return true;
    }

    function openWidget(){
      if (!createWidgetIfNeeded()) return;
      try {
        widget.update({ folder: currentFolder }); // ensure folder matches client
        widget.open();
      } catch (e) {
        console.error(e);
        // As a last resort, show fallback link
        $fallbackLink.href = buildFallbackLink();
        $fallback.style.display = 'block';
        showError('Could not open the uploader. Use the basic uploader link below.');
      }
    }

    function unlock(){
      hideMsgs();
      const v = ($pin.value || '').replace(/\D/g,'').slice(0,4);
      if (v.length !== 4) { showError('Enter your 4-digit PIN.'); return; }

      const found = findClient(v);
      if (!found) { showError('Invalid PIN. Please try again or contact Jessabel.'); return; }

      currentClient = found;
      currentFolder = `${ROOT_FOLDER}/${found.folder}`;

      showOk(`Welcome, ${found.name}. Uploads will go to “${currentFolder}”. The upload window will open now…`);
      // Open the widget immediately
      openWidget();
    }

    $unlock.addEventListener('click', unlock);
    $pin.addEventListener('keydown', (e) => { if (e.key === 'Enter') unlock(); });
    $clear.addEventListener('click', () => { $pin.value=''; hideMsgs(); });

    // Focus PIN on load
    window.addEventListener('load', () => $pin.focus());
  </script>
</body>
</html>
